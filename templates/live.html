{% extends "base.html" %}
{% block title %}Live Monitor{% endblock %}
{% block page_title %}Live Monitor{% endblock %}

{% block content %}

<!-- TOP ROW â€” controls + session stats -->
<div class="grid-2 mb-6">

    <!-- Controls -->
    <div class="panel">
        <div class="panel-header">
            <div class="panel-title">â—‰ Monitor Controls</div>
            <div id="statusBadge" style="display:flex;align-items:center;gap:8px;
                 font-size:12px;color:var(--dim);">
                <div id="statusDot" style="width:8px;height:8px;border-radius:50%;
                     background:var(--dim);transition:all 0.3s;"></div>
                <span id="statusText">Stopped</span>
            </div>
        </div>
        <div class="panel-body">
            <div class="form-group">
                <label>Filter by User</label>
                <input type="text" id="userFilter" placeholder="e.g. shashi (leave blank for all)">
            </div>
            <div style="display:flex;gap:10px;margin-top:4px;">
                <button class="btn btn-success" onclick="startFeed()">â–¶ Start</button>
                <button class="btn btn-danger"  onclick="stopFeed()" id="stopBtn" disabled>â–  Stop</button>
                <button class="btn btn-primary" onclick="clearFeed()">âŒ« Clear</button>
            </div>

            <div style="margin-top:20px;padding:14px;background:rgba(0,0,0,0.3);
                        border-radius:4px;border-left:3px solid var(--green);">
                <div style="font-size:10px;color:var(--green);font-family:var(--ui);
                            letter-spacing:2px;margin-bottom:8px;">TERMINAL COMMAND</div>
                <div class="mono" style="font-size:12px;color:var(--text);line-height:1.8;">
                    python monitor.py \<br>
                    &nbsp;&nbsp;--user YOUR_USERNAME \<br>
                    &nbsp;&nbsp;--history ~/.bash_history
                </div>
                <div style="font-size:11px;color:var(--dim);margin-top:8px;">
                    Run this in a separate terminal while the app is running.
                </div>
            </div>
        </div>
    </div>

    <!-- Session Stats -->
    <div class="panel">
        <div class="panel-header">
            <div class="panel-title">âš¡ Session Stats</div>
        </div>
        <div class="panel-body">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
                <div style="text-align:center;padding:16px;background:rgba(0,0,0,0.2);border-radius:4px;">
                    <div id="statCmds" style="font-family:var(--mono);font-size:28px;color:var(--accent);">0</div>
                    <div style="font-size:10px;color:var(--dim);margin-top:4px;letter-spacing:1px;">COMMANDS</div>
                </div>
                <div style="text-align:center;padding:16px;background:rgba(0,0,0,0.2);border-radius:4px;">
                    <div id="statAlerts" style="font-family:var(--mono);font-size:28px;color:var(--red);">0</div>
                    <div style="font-size:10px;color:var(--dim);margin-top:4px;letter-spacing:1px;">ALERTS</div>
                </div>
                <div style="text-align:center;padding:16px;background:rgba(0,0,0,0.2);border-radius:4px;">
                    <div id="statFlagged" style="font-family:var(--mono);font-size:28px;color:var(--orange);">0</div>
                    <div style="font-size:10px;color:var(--dim);margin-top:4px;letter-spacing:1px;">FLAGGED</div>
                </div>
                <div style="text-align:center;padding:16px;background:rgba(0,0,0,0.2);border-radius:4px;">
                    <div id="statAvgRisk" style="font-family:var(--mono);font-size:28px;color:var(--green);">0.0</div>
                    <div style="font-size:10px;color:var(--dim);margin-top:4px;letter-spacing:1px;">AVG RISK</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- LIVE COMMAND FEED -->
<div class="panel mb-6">
    <div class="panel-header">
        <div class="panel-title">ðŸ“¡ Live Command Feed</div>
        <span style="font-size:11px;color:var(--dim);">auto-refreshes every 2s when active</span>
    </div>
    <div id="cmdFeed"
         style="background:#020810;min-height:200px;max-height:340px;overflow-y:auto;
                padding:14px;font-family:var(--mono);font-size:12px;color:var(--green);
                border-top:1px solid var(--border);">
        <div style="color:var(--dim);">[ waiting to start... click â–¶ Start above ]</div>
    </div>
</div>

<!-- LIVE ALERTS FEED -->
<div class="panel">
    <div class="panel-header">
        <div class="panel-title">ðŸš¨ Live Alerts</div>
    </div>
    <div class="panel-body" style="padding:0;">
        <table class="data-table" id="alertTable">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>User</th>
                    <th>Sequence</th>
                    <th>Risk</th>
                    <th>Commands</th>
                </tr>
            </thead>
            <tbody id="alertBody">
                <tr>
                    <td colspan="5" style="text-align:center;color:var(--dim);padding:30px;">
                        No live alerts yet.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let pollTimer   = null;
let lastCmdId   = 0;
let lastAlertId = 0;
let totalCmds   = 0;
let totalAlerts = 0;
let totalFlagged = 0;
let riskSum     = 0;
let running     = false;


function startFeed() {
    running = true;
    document.getElementById('stopBtn').disabled = false;

    // status dot â†’ green + pulsing
    const dot  = document.getElementById('statusDot');
    const text = document.getElementById('statusText');
    dot.style.background  = 'var(--green)';
    dot.style.boxShadow   = '0 0 8px var(--green)';
    dot.style.animation   = 'blink 1.5s infinite';
    text.textContent      = 'Monitoring';
    text.style.color      = 'var(--green)';

    appendCmd('[ Feed started â€” polling every 2s ]', 'dim');
    pollTimer = setInterval(poll, 2000);
    poll(); // immediate first poll
}


function stopFeed() {
    running = false;
    clearInterval(pollTimer);
    pollTimer = null;
    document.getElementById('stopBtn').disabled = true;

    const dot  = document.getElementById('statusDot');
    const text = document.getElementById('statusText');
    dot.style.background = 'var(--dim)';
    dot.style.boxShadow  = 'none';
    dot.style.animation  = 'none';
    text.textContent     = 'Stopped';
    text.style.color     = 'var(--dim)';

    appendCmd('[ Feed stopped ]', 'dim');
}


function clearFeed() {
    document.getElementById('cmdFeed').innerHTML = '';
    document.getElementById('alertBody').innerHTML =
        '<tr><td colspan="5" style="text-align:center;color:var(--dim);padding:30px;">No live alerts yet.</td></tr>';
    totalCmds = totalAlerts = totalFlagged = 0;
    riskSum = 0;
    updateStats();
}


async function poll() {
    const user = document.getElementById('userFilter').value.trim();

    // poll commands
    try {
        const url = `/api/live-log?since=${lastCmdId}${user ? '&user=' + user : ''}`;
        const res  = await fetch(url);
        const rows = await res.json();

        rows.forEach(r => {
            lastCmdId = Math.max(lastCmdId, r.id);
            const ts   = r.timestamp.substring(11, 19);
            const risk = parseFloat(r.risk_score);

            let icon, cls;
            if (r.flagged) {
                icon = 'ðŸš¨';
                cls  = 'alert';
            } else if (risk >= 6) {
                icon = 'ðŸ”´';
                cls  = 'high';
            } else if (risk >= 3) {
                icon = 'ðŸŸ¡';
                cls  = 'warn';
            } else {
                icon = 'ðŸŸ¢';
                cls  = '';
            }

            appendCmd(`[${ts}] ${icon} [${r.user}]  ${r.command}   (risk: ${risk.toFixed(1)})`, cls);
            totalCmds++;
            riskSum += risk;
            if (r.flagged) totalFlagged++;
        });

        if (rows.length) updateStats();
    } catch(e) {
        appendCmd('[poll error: ' + e.message + ']', 'warn');
    }

    // poll alerts
    try {
        const aurl = `/api/recent-alerts?since=${lastAlertId}${user ? '&user=' + user : ''}`;
        const ares  = await fetch(aurl);
        const arows = await ares.json();

        arows.forEach(a => {
            lastAlertId = Math.max(lastAlertId, a.id);
            totalAlerts++;
            addAlertRow(a);
        });

        if (arows.length) updateStats();
    } catch(e) {}
}


function appendCmd(text, cls) {
    const feed = document.getElementById('cmdFeed');

    // remove placeholder
    const placeholder = feed.querySelector('div');
    if (placeholder && placeholder.style.color === 'var(--dim)') {
        placeholder.remove();
    }

    const line = document.createElement('div');
    line.style.lineHeight = '1.7';
    line.style.borderBottom = '1px solid rgba(30,58,95,0.2)';
    line.style.paddingBottom = '2px';

    if (cls === 'alert' || cls === 'high') {
        line.style.color = 'var(--red)';
    } else if (cls === 'warn') {
        line.style.color = 'var(--orange)';
    } else if (cls === 'dim') {
        line.style.color = 'var(--dim)';
    }

    line.textContent = text;
    feed.appendChild(line);
    feed.scrollTop = feed.scrollHeight;

    // cap at 300 lines
    while (feed.children.length > 300) {
        feed.removeChild(feed.firstChild);
    }
}


function addAlertRow(a) {
    const tbody = document.getElementById('alertBody');

    // remove "no alerts" placeholder
    if (tbody.querySelector('td[colspan]')) {
        tbody.innerHTML = '';
    }

    const rs       = parseFloat(a.risk_score);
    const badgeCls = rs >= 6 ? 'badge-high' : rs >= 3 ? 'badge-medium' : 'badge-low';
    const cmds     = a.risky_cmds
        ? a.risky_cmds.split(',').map(c => `<span class="tag">${c}</span>`).join('')
        : '';
    const ts = a.timestamp ? a.timestamp.substring(11, 16) : 'â€”';

    const row = document.createElement('tr');
    row.style.animation = 'fadeIn 0.3s ease';
    row.innerHTML = `
        <td style="font-size:11px;color:var(--dim);">${ts}</td>
        <td class="mono" style="color:var(--accent);">${a.user}</td>
        <td class="mono" style="max-width:220px;overflow:hidden;text-overflow:ellipsis;
            white-space:nowrap;" title="${a.sequence}">${a.sequence}</td>
        <td><span class="badge ${badgeCls}">${rs}</span></td>
        <td>${cmds}</td>
    `;
    tbody.insertBefore(row, tbody.firstChild); // newest first
}


function updateStats() {
    document.getElementById('statCmds').textContent    = totalCmds;
    document.getElementById('statAlerts').textContent  = totalAlerts;
    document.getElementById('statFlagged').textContent = totalFlagged;
    document.getElementById('statAvgRisk').textContent =
        totalCmds > 0 ? (riskSum / totalCmds).toFixed(1) : '0.0';
}
</script>
{% endblock %}