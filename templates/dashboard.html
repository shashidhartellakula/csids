{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block page_title %}Security Dashboard{% endblock %}

{% block content %}

<div class="stat-grid">
    <div class="stat-card blue">
        <div class="stat-label">Monitored Users</div>
        <div class="stat-value">{{ total_users }}</div>
        <div class="stat-sub">trained profiles</div>
    </div>
    <div class="stat-card red">
        <div class="stat-label">Total Alerts</div>
        <div class="stat-value">{{ total_alerts }}</div>
        <div class="stat-sub">all time</div>
    </div>
    <div class="stat-card warn">
        <div class="stat-label">Alerts (24h)</div>
        <div class="stat-value">{{ alerts_24h }}</div>
        <div class="stat-sub">last 24 hours</div>
    </div>
    <div class="stat-card green">
        <div class="stat-label">Top User Alerts</div>
        <div class="stat-value">{{ top_users[0][1] if top_users else 0 }}</div>
        <div class="stat-sub">{{ top_users[0][0] if top_users else 'none' }}</div>
    </div>
</div>

<div class="panel">
    <div class="panel-header">
        <div class="panel-title">⚠ Recent Alerts</div>
        <a href="{{ url_for('alerts_page') }}" class="btn btn-primary btn-sm">View All</a>
    </div>
    <div class="panel-body" style="padding:0;">
        {% if recent_alerts %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Risk</th>
                    <th>Sequence</th>
                    <th>Reason</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
            {% for a in recent_alerts %}
            <tr>
                <td class="mono">{{ a['user'] }}</td>
                <td>
                    {% set rs = a['risk_score'] %}
                    {% if rs >= 6 %}
                        <span class="badge badge-high">{{ rs }}</span>
                    {% elif rs >= 3 %}
                        <span class="badge badge-medium">{{ rs }}</span>
                    {% else %}
                        <span class="badge badge-low">{{ rs }}</span>
                    {% endif %}
                </td>
                <td class="mono" style="max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"
                    title="{{ a['sequence'] }}">{{ a['sequence'] }}</td>
                <td style="font-size:12px;color:var(--dim);">{{ a['reason'] }}</td>
                <td style="font-size:11px;color:var(--dim);">{{ a['timestamp'][:16] }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="padding:40px;text-align:center;color:var(--dim);">
            <div style="font-size:36px;margin-bottom:8px;">✅</div>
            No alerts yet — train a profile and run detection to get started.
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}